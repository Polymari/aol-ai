<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLock AI Enrollment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-container {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            width: 95%;
            height: 80vh;
        }

        /* Video Section */
        .video-wrapper {
            flex: 2;
            background: #000;
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            border: 2px solid #334155;
        }

        #video_feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .live-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .live-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        /* Sidebar Controls */
        .controls-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid #334155;
        }

        h2 { font-size: 1.25rem; margin-bottom: 1rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        input[type="text"] {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: 0.2s;
        }

        input:focus { outline: none; border-color: var(--primary); }

        button {
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            color: white;
            margin-bottom: 0.5rem;
        }

        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #4f46e5; }

        .btn-record { background: var(--success); display: none; }
        .btn-record.recording { background: var(--danger); animation: pulse-border 2s infinite; }

        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.3); }

        /* Camera Toggle Styles */
        .btn-camera-start { background: var(--success); }
        .btn-camera-stop { background: var(--danger); }
        
        /* Settings Button */
        .btn-settings { background: #475569; margin-top: 0.5rem; }
        .btn-settings:hover { background: #64748b; }

        /* Status Log */
        .status-box {
            margin-top: auto;
            font-family: monospace;
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--card);
            padding: 2rem;
            border-radius: 1rem;
            width: 400px;
            border: 1px solid #334155;
            color: var(--text);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .slider-group { margin-bottom: 1.5rem; }
        .slider-group label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 600; color: #cbd5e1; }
        .slider-group input { width: 100%; cursor: pointer; accent-color: var(--primary); }
        .btn-close { background: transparent; border: 1px solid #475569; color: #94a3b8; margin-top: 0.5rem; }
        .btn-close:hover { background: #334155; color: white; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="video-wrapper">
            <div class="live-badge">LIVE FEED</div>
            <img id="video_feed" src="{{ url_for('video_feed') }}" alt="Connect Camera">
        </div>

        <div class="controls-wrapper">
            
            <!-- Camera Control -->
            <div class="card">
                <h2>1. System Control</h2>
                <!-- SINGLE TOGGLE BUTTON -->
                <button id="btnCamToggle" class="btn-camera-start" onclick="toggleCamera()">
                    ‚ñ∂ Start Camera
                </button>
                <button class="btn-danger" onclick="clearDatabase()">
                    üóëÔ∏è Wipe All Data
                </button>
                <button class="btn-settings" onclick="openSettings()">
                    ‚öôÔ∏è Recognition Settings
                </button>
            </div>

            <!-- Enrollment -->
            <div class="card">
                <h2>2. Enrollment</h2>
                <input type="text" id="nameInput" placeholder="Enter Full Name..." autocomplete="off">
                <button id="btnInit" class="btn-primary" onclick="startEnrollment()">
                    Start Enrollment Session
                </button>
                <button id="btnRecord" class="btn-record" onclick="toggleRecord()">
                    ‚óè Start Recording
                </button>
            </div>

            <div class="status-box" id="statusLog">
                > System Ready.<br>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Adjust Parameters</h2>
            
            <div class="slider-group">
                <label>Match Tolerance (Loose vs Strict) <span id="sensVal" style="color:var(--primary)">75</span></label>
                <input type="range" id="sensitivity" min="40" max="90" value="75" oninput="document.getElementById('sensVal').innerText = this.value">
                <small style="color:#64748b">Higher = Easier to match (but more errors)</small>
            </div>

            <div class="slider-group">
                <label>Smoothing (Stability) <span id="smoothVal" style="color:var(--primary)">8</span></label>
                <input type="range" id="smoothing" min="1" max="20" value="8" oninput="document.getElementById('smoothVal').innerText = this.value">
                <small style="color:#64748b">Higher = Less flickering name tags</small>
            </div>

            <button class="btn-primary" onclick="saveSettings()">Save Changes</button>
            <button class="btn-close" onclick="closeSettings()">Cancel</button>
        </div>
    </div>

    <script>
        function log(msg, type='neutral') {
            const box = document.getElementById('statusLog');
            let color = '#94a3b8';
            if(type === 'success') color = '#22c55e';
            if(type === 'error') color = '#ef4444';
            box.innerHTML = `> <span style="color:${color}">${msg}</span><br>` + box.innerHTML;
        }

        async function sendCommand(cmd, value="") {
            const res = await fetch('/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: cmd, value: value })
            });
            return await res.json();
        }

        // --- 1. Camera Toggle Logic ---
        async function toggleCamera() {
            const btn = document.getElementById('btnCamToggle');
            try {
                const data = await sendCommand('toggle_camera');
                
                if (data.active) {
                    btn.innerText = "‚ñ† Stop Camera";
                    btn.classList.remove('btn-camera-start');
                    btn.classList.add('btn-camera-stop');
                    log("Camera Started.", "success");
                } else {
                    btn.innerText = "‚ñ∂ Start Camera";
                    btn.classList.remove('btn-camera-stop');
                    btn.classList.add('btn-camera-start');
                    log("Camera Paused.", "neutral");
                }
            } catch (err) {
                log("Backend Error", "error");
            }
        }

        // --- 2. Enrollment Logic ---
        async function startEnrollment() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) { log("Enter name first!", "error"); return; }

            const data = await sendCommand('start_enroll', name);
            if (data.status) {
                log(`Session: ${data.name}`, "success");
                document.getElementById('btnInit').style.display = 'none';
                document.getElementById('nameInput').disabled = true;
                document.getElementById('btnRecord').style.display = 'block';
            }
        }

        async function toggleRecord() {
            const btn = document.getElementById('btnRecord');
            const data = await sendCommand('toggle_record');
            
            if (data.status === "Recording...") {
                btn.classList.add('recording');
                btn.innerText = "‚ñ† Stop & Save";
                log("Recording...", "success");
            } else {
                btn.classList.remove('recording');
                btn.style.display = 'none';
                document.getElementById('btnInit').style.display = 'block';
                document.getElementById('nameInput').disabled = false;
                document.getElementById('nameInput').value = "";
                btn.innerText = "‚óè Start Recording";
                log("Saved Data.", "success");
            }
        }

        async function clearDatabase() {
            if(!confirm("Delete all face data?")) return;
            await sendCommand('clear_db');
            log("Database Wiped.", "error");
        }

        // --- 3. Settings Modal Logic ---
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        async function saveSettings() {
            const sens = document.getElementById('sensitivity').value;
            const smooth = document.getElementById('smoothing').value;
            
            // Send new settings to python
            const payload = JSON.stringify({ sensitivity: parseInt(sens), smoothing: parseInt(smooth) });
            await sendCommand('update_settings', payload);
            
            log(`Settings Updated (Tol:${sens}, Smooth:${smooth})`, "success");
            closeSettings();
        }
    </script>
</body>
</html>